from os.path import join, abspath

gtest_dir = 'GTEST_DIR = ../../../../AutoGradingSystem/src/gtest-1.7.0\n'
sig_dir = 'SIG_DIR = ../../../../AutoGradingSystem/src/include\n'
helper_dir = 'HELPER_DIR = ../../../../AutoGradingSystem/src/include/oop\n'
cpp_flags = 'CPPFLAGS += -isystem $(GTEST_DIR)/include\n'
cxx_flags = 'CXXFLAGS += -g -Wall -Wextra -pthread\n'
test = 'COMPILE = CompileTest\nDEATH = DeathTest\nUNIT = UnitTest\n'
gtest_header = 'GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \\\n\t\t$(GTEST_DIR)/include/gtest/internal/*.h\n'
all = 'compile : $(COMPILE)\ndeath : $(DEATH)\nunit : $(UNIT)\n'
clean = 'clean :\n\t\trm -f $(COMPILE) gtest_main.a *.o\n\t\trm -f $(DEATH) gtest_main.a *.o\n\t\trm -f $(UNIT) gtest_main.a *.o \n\n'
encoding = ' -finput-charset=CHARSET '


def CreateMakeFile(student_dir, path, classes):


    print("Make Makefile......\n")

    student_dir = abspath(student_dir)
    path = [abspath(p) for p in path]



    # Make Death test C++ file
    wf = open(join(student_dir, 'Makefile'), 'w')

    wf.write(gtest_dir)
    wf.write(sig_dir)
    wf.write(helper_dir)
    wf.write(cpp_flags)
    wf.write(cxx_flags)
    wf.write(test)
    wf.write(gtest_header)
    wf.write(all)
    wf.write(clean)
    wf.write('main.o :' + student_dir + '/main.cpp \n')
    wf.write('\t$(CXX) $(CPPFALGS) $(CXXFLAGS) -w -c '+encoding + student_dir + '/main.cpp\n')

    for i in range(0, len(classes)):
        cc = path[i].replace('.h','.cpp')
        wf.write(classes[i] + '.o : ' + cc + ' ' + path[i] + ' $(GTEST_HEADERS)\n')
        wf.write('\t$(CXX) $(CPPFALGS) $(CXXFLAGS) -w -c ' +encoding+ cc + '\n')

    wf.write('DeathTest.o : ' + join(student_dir, 'DeathTest.cpp') + ' ')

    for p in path:
        wf.write(p + ' ')

    wf.write('$(GTEST_HEADERS)\n\t')
    wf.write('$(CXX) $(CPPFLAGS) $(CXXFLAGS) -w -c ' +encoding+ join(student_dir, 'DeathTest.cpp') + '\n')

    wf.write('UnitTest.o : ' + join(student_dir, 'UnitTest.cpp') + ' ')

    for p in path:
        wf.write(p + ' ')

    wf.write('$(GTEST_HEADERS)\n\t')
    wf.write('$(CXX) $(CPPFLAGS) $(CXXFLAGS) -w -c ' +encoding+ join(student_dir, 'UnitTest.cpp') + '\n')


    wf.write('CompileTest : ')
    for Class in classes:
        wf.write(Class + '.o ')
    wf.write(
        "main.o\n"
        "\t$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -w -o " +encoding+ " $@ $(SIG_DIR)/signal.h $(SIG_DIR)/signal.cc\n")

    wf.write('DeathTest : ')
    for Class in classes:
        wf.write(Class + '.o ')
    wf.write(
        "DeathTest.o ../../../../AutoGradingSystem/src/gtest-1.7.0/gtest_main.a\n"
        "\t$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -w -o " +encoding+ " $@ $(SIG_DIR)/signal.h $(SIG_DIR)/signal.cc $(HELPER_DIR)/isomorphic.h\n")

    wf.write('UnitTest : ')
    for Class in classes:
        wf.write(Class + '.o ')
    wf.write(
        "UnitTest.o ../../../../AutoGradingSystem/src/gtest-1.7.0/gtest_main.a\n"
        "\t$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -w -o  " +encoding+ " $@ $(SIG_DIR)/signal.h $(SIG_DIR)/signal.cc $(HELPER_DIR)/isomorphic.h\n")

    wf.close()
